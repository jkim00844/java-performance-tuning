# Story14. 서버를 어떻게 세팅해야 할까?
설정에 대한 튜닝은 반드시 해야 한다.  
대게 기본값으로 최대한의 성능을 낼 수 있는 것은 없다.  
프로그램에 문제가 없는데 세팅 값 하나 때문에 애플리케이션의 성능이 안 좋아지는 경우가 굉장히 많기 때문이다.  
거꾸로 이야기하면, 만약 성능상 이슈가 있을때 그 원이 설정때문이라면 아주 쉽게 해결할 수 있다.  

### 설정해야 하는 대상
웹 기반의 시스템에서 성능에 영향을 줄만한 세팅
- 웹 서버 세팅 
- WAS 서버 세팅 DB 서버 세팅
- DB 서버 세팅
- 장비 세팅

### 아파치 웹 서버의 설정
웹 서버는 반드시 WAS 앞에 두어야 한다.  
정적인 부분은 웹서버에서 처리해야 한다. 그렇지 않으면 WAS 서버에서 웹 서버의 역할까지 수행해야 한다.   
웹 서버를 WAS 서버 앞에 두지 않으면 이미지, CSS, 자바 스크립트, HTML 등을 처리하느라 아까운 WAS 서버의 스레드를 점유하게 된다.  
반드시 상용 웹 서버나 아파치 웹 서버를 WAS 앞 단에 두고 운영해야 한다.  

아파치 웹 서버의 설정을 바꾸는 방법은   
설치 촐더 하단의  conf 디렉터리에 있는 httpd.conf 파일을 수정하는 것이다.  
```
ThreadsPerChile 250 
MaxRequestsPerChile 0
```
ThreadsPerChild는 웹 서버가 사용하는 스레드의 개수를 지정한다.  
만약 이 수치가 적게 지정되어 있다면, 늘려 주어야 한다. 그래야 더 많은 사용자의 요청을 처리할 수 있게 된다.  

MaxRequestsPerChild는 최대 요청 개수를 지정한다.  
0이면 그 수에 제한을 두지 않겠다는 의미다. 기본값인 0으로 두길 권장

스레드와 관련된 내용을 보다 세밀하게 지정하려면  
httpd.conf 파일에서 #으로 주석 처리되어 있는 "Include conf/extra/httpd-mpm.conf"를 찾아서 주석을 해제한다.  
httpd-mpm.conf를 통해서 세밀한 스레드 설정 정보를 지정한다.  
```java
<IfModule mpm_worker_module>
    StartServers 2
    MaxClients 150
    MinSpareThreads 25
    MaxSpareThreads 75
    ThreadsPerChile 25
    MaxRequestsPerChild 0
</IfModule>
```

- StartServers: 서버를 띄울 때 프로세스의 개수를 지정한다. 보통 이야기하는 child 프로세스의 개수를 이야기한다.
- MaxClients: 최대 처리 가능한 클라이언트의 수를 지정한다.
- MinSpareThreads: 최소 여유 스레드 수를 지정한다.
- MaxSpareThreads: 최대 여유 스레드 수를 지정한다.
- ThreadsPerChild: 프로세스당 스레드 수를 지정한다.
- MaxRequestsPerChild: 앞서 이야기한 MaxRequestsPerChild와 같은 의미dlek.

여기에서는 프로세스 수가 2개이고, 프로세스당 스레드 수가 25이므로   
기본적으로 50개의 요청을 처리할 수 있다.  
또한 최대 여유 스레드가 75개이므로, 최대 사용 가능한 클라이언트 수는 150이 된다.

예를 들어 웹 서버에서 150명의 요청을 받고 있는다면 그 요청을 전달받은 WAS도 마찬가지로 150명의 요청을 받는다.  
그런데, 자바는 GC를 할 때 JVM 자체가 멈춘다.  
만약 이 GC가 2초 걸리면 어떻게 될까? 아파시 웹서에 총 300명의 요청을 기다리게 되며  
그동안 GC를 하는 동안 WAS가 멈추기 때문에 새로운 연결을 할 수 없다.  
이 경우 Tomcat에서는 AJP Connector라는 웹 서버와 WAS 사이의 커넥터에 설정한 blacklog라는 값의 영향을 받는다.  
만약 이 값을 설정하지 않으면 기본값은 100이다.  
즉, WAS가 응답하지 않을 때 100개의 요청 까지 큐에 담아둔다.  
따라서, 100개를 넘는 요청들은 503이라는 HTTP 헤더 코드 값을 리턴 받게 된다. 

이러한 값을 받지 위해 다음과 같은 조치를 취하는 것이 좋다.  
1. 서버를 늘린다: 어떻게 보면 가장 편한 방법이다. 금전적인 여유가 있을 때 말이다.
2. 서비스를 튜닝한다: 서비스가 응답이 안 되는 원인을 찾고 튜닝한다.  
하지만 말이 쉽지 실제로 그 원일을 찾는 데는 몇 시간이 소요될 수도 있으며, 몇 달이 걸릴 수도 있다.  
3. GC 튜닝을 한다: 만약 GC가 오래 소요되어 응답이 안될 경우 GC 튜닝을 한다. (17장에 자세히)  
4. 각종 옵션 값을 튜닝한다: 어떻게 보면 가장 간단한 방법일 수도 있다.  
하지만, 잘못 설정할 경우 오히려 더 큰 문제가 야기될 수 있기 때문에 해당 웹 서버 및 WAS의 전문가나 엔지니어와 같이 이야기해서 옵션 값을 설정해야 한다.  

### 웹 서버의 Keep Alive
모든 웹서버를 설정할 때 중요한 값이 KeepAlive 설정이다.  
아파치 웹 서버의 경우, httpd.conf 파일에 다음의 설정이 없으면 간단하게 한 줄 추가하면 된다.
```
KeepAlive On
```
웹 서버와 웹 브라우저가 연결이 되었을 때 KeepAlive 기능이 켜져 있지 않으면, 매번 HTTP 연결을 맺었다 끊었다 하는 작업을 반복한다.  
초기 화면에서 엄청나게 많은 이미지와 CSS, 자바 스크립트 등의 파일을 받아야 하는 사이트에서 KeepAlive 옵션이 적용되어 있지 않다면,  
초기 화면을 띄우는 데 몇 분씩 소요될지도 모른다.  
KeepAlive 설정을 할 때 반드시 같이 해야 하는 설정은 KeepAliveTimeout 이다.
초 단위로 KeepAlive가 끊기는 시간을 설정할 수 있다.  
```
KeepAliveTimeout 15
```
만약 사용자가 너무 많아 접속이 잘 안될 경우, 이 설정을 5초 정도로 짧게 주는 것도 서버의 리소스를 보다 효율적으로 사용할 수 있는 방법이다.  
추가로 서비스의 상황에 따라서 KeepAlive 옵션을 껐을 때 보다 좋은 성능이 나오게 되는 경우가 존재한다.  
무조건 KeepAlive를 켜야 한다는 것이 아니니 상황에 맞게 사용해야 한다.


참고: 사용자 접근이 많은 사이트에서는 이미지나 CSS와 같이 정적파일들을 일반적인 웹서버에서 처리하지 않고   
CDN(Content Delivery Network)이라고 하는 서비스를 이용한다.  
즉, 별도 URL에서 해당 컨텐츠들을 내려받도록 설정하고, 동적 컨텐츠들은 WAS에서 처리하면 Web-WAS 서버의 부담도 줄어들게 되지만 비용 부담이 있다.  

### DB Connection Pool 및 스레드 개수 설정
WAS에서 설정해야 하는 값은 너무나 많다.  
그중 가장 성능에 많은 영향을 주는 것은 DB Connection Pool과 스레드 개수이다.  
이 두 항목의 개수는 메모리와 관련이 있다. 많이 사용할수록 메모리를 많이 점유하게 된다.  

대부분의 WAS에서는 DB Connection Pool의 개수를 최소치, 증가치, 최대치 등으로 자세하게 지정할 수 있다.  
최소치를 말 그대로 서버가 기동될 때 연결을 수행하는 개수이다.  
개발자용 PC에서는 이 값이 높을 필요가 없으므로 이 값은 최소한으로 지정하고
운영 중에는 최소 및 최대 값을 동일하게 하는 것이 좋다.  
만약 DB 서버의 리소스가 부족하다면 최소값을 적게 해 놓는 것도 한 방법이 될 수 있다.  

대부분 WAS에서 두 설정 값의 기본 개수가 10,20개 정도이다.  
따라서 기본 값으로 서비스를 오픈하면 서버가 원하는 요청량을 처리하지 못하게 된다.   
DB Connection Pool은 보통 40,50개로 지정하며, 스레드 개수는 이보다 10개 정도 더 지정한다.   
이렇게 지정하는 이유는,
스레드 : 40, DB Connection Pool: 50일 경우, 적어도 10개의 연결은 사용하지 않게 된다.  

DB Connection Pool의 적절한 수치 찾는 방법  
DB Connection Pool을 40개로 잡아 놓았을 때 DB의 CPU 사용량이 100%에 도달했다면  
일단 DB의 CPU를 많이 점유하는 쿼리를 탖아 튜닝해야 한다.  
무조건 DB Connection Pool을 늘리는 게 답이 아니다.  
이를 늘릴 수록 모든 DB와의 연결을 전부 사용하고 응답시간이 더 느려질 수 있기 때문이다.  

이번에는  
DB의 CPU사용량은 50%도 되지 않는 상황에서 WAS의 CPU사용량이 100%에 도달하는 상황이다.   
DB Connection Pool은 20개이다.  
이 경우에는 WAS 애플리케이션을 튜닝해야 한다.  
만약 이미 튜닝된 경우라면 DB Connection Pool을 늘리는 것이 좋다.  
(가끔 보면 서버의 대수를 늘리는 경우를 가끔 보는데 서버를 늘리는 것은 가장 마지막에 해야 한다는 사실을 잊으면 안된다.)

DB Connection Pool의 개수 만큼 중요한 값은 대기시간이다.  
DB Connection Pool의 개수를 넘어 섰을 때 애플리케이션은 어디 남는 connection이 없나 찾는 시간이 대기 시간이다.  
MyBatis에서는 poolTimeToWait이라는 값으로 대기시간을 결정하며 기본은 20초이다.  
대기 시간은 너무 짧게 주면 안된다. 바로 DB와 연결하지 못했다고 Timeout을 내뿜을 수 있기 때문이다.


DB와 연동하는 프레임워크를 설정할 때는 
Pool의 개수,    
Wait과 관련된 값이 들어간 값,   
Timeout관련 된 설정들을 시스템의 상황에 맞게 설정해야지만 예기치 못한 오류 페이지를 만나지 않을 것이다.  


### WAS 인스턴스 개수 설정
하나의 장비에 WAS의 인스턴스 개수를 몇개로 해야된다는 규칙은 어느 문서에도 존재하지 않는다. 즉 절댓값이 없다는 뜻이다.   
보통 1~2개의 CPU당 하나의 인스턴스를 지정하는 것이 좋다고 이야기 하지만  
인스턴스의 개수는 성능 테스트를 통해 구하는 것이 바람직하다.  
만약 CPU core개수가 36개인 장비에  
인스턴스 1: 500TPS, 
인스턴스 2: 700TPS, 
인스턴스 3: 720TPS, 
인스턴스 4: 730TPS,  
가 나온다고 가정하면 이 상황에서는 인스턴스 2,3개 가 적당하다.  
인스턴스를 더늘린다고 TPS가 증가하지 않는 상황에서는 오히려 유지보수성만 떨어진다.  
인스턴스 개수가 많을 수록 배포하기도 어렵고, 모니터링 및 장애 상황시 문제를 찾고 해결하기가 어렵다.  

### Session Timeout 시간 설정  
세션 종료시간은 설정하지 않으면 계속 세션이 유지되기 때문에 꼭 세션 종료시간 지정해야 한다.  

WEB-INF 폴더 하단의 web.xml 파일에서 설정한다.
```
<session-timeout>30</session-timeout>
```
세션 종료 시간 설정 값은 분 단위이다.  
설정되어 있는 분만큼 요청이 없으면 세션을 메모리에서 제거한다.  
이 설정을 하지 않은 상태에서,  
WAS에서 따로 설정한 바가 없거나 세션 객체의 invalidate()메서드가 수행되지 않으면 세션은 삭제되지 않으므로 유의해야 한다.



### 정리하며
모든 수치에는 절댓값은 없다.  
반드시 성능테스트를 수행해 가장 적절한 튜닝값을 찾아내고 해당 시스템이 견딜 수 있는 사용자 수를 알고 있어야 한다.  
