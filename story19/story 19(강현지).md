# story 19

# GC 튜닝을 항상 할 필요는 없다

JVM의 메모리 크기도 지정하지 않았고, Timeout이 지속적으로 발생하고 있다면 GC 튜닝을 하는 것이 좋음

## GC 튜닝의 목적

1. Old 영역으로 넘어가는 객체의 수 최소화
    
    Old 영역의 GC는 New 영역의 GC에 비해 상대적으로 시간이 오래 소요되기 때문에 Old 영역으로 이동하는 객체의 수를 줄이면 Full GC 가 발생하는 빈도를 많이 줄일 수 있음
    
2. Full GC 시간 줄이기
    
    Full GC의 수행 시간은 상대적으로 Young GC에 비해 김
    
    ⇒ 실행에 시간이 오래 소요되면 연계된 여러 부분에서 타임아웃 발생 가능
    

## GC 성능에 영향을 주는 옵션

1. 메모리 크기 관련 옵션
    1. 자주 사용하는 옵션 : -Xms, -Xmx, -XX:NewRatio
2. GC 방식
    1. GC 방식에 따라 지정할 수 있는 옵션

## GC 튜닝 절차

1. GC 상황 모니터링
2. 모니터링 결과 분석 후 GC 튜닝 여부 결정
3. GC 방식/메모리 크기 지정
    1. 서버가 여러 대이면 서버에 GC 옵션을 서로 다르게 지정해서 GC 옵션에 따른 차이 확인
4. 결과 분석
    1. GC 옵션 지정하고 적어도 24시간 이상 데이터 수집 후에 분석 실시
    2. GC 방식/메모리 크기를 변경해가면서 최적의 옵션 찾기
5. 결과가 만족스러울 경우 전체 서버에 반영 및 종료

### 1, 2 단계 : GC 상황 모니터링 및 결과 분석

운영중인 WAS의 GC 상황을 확인하는 가장 좋은 방법은 jstat 명령어 사용

-verbosegc 옵션으로 로그를 남겨 분석하는 것이 가장 좋음(HPJMeter 도구 사용)

**GC 튜닝이 필요 없는 경우**

- Minor GC의 처리 시간이 빠름
- Minor GC 주기가 빈번하지 않음
- Full GC의 처리 시간이 빠름
- Full GC 주기가 빈번하지 않음


### 3-1 단계 : GC 방식 지정

GC 방식은 Oracle JVM 기준 5개가 있는데 그중 Serial GC는 운영에서 사용하지 못하고, JDK 7이 아니라면 사용하지 못하는 GC를 빼고 Parallel GC, Parallel Compacting GC, CMS GC 중 하나를 선택 가능

일반적으로 CMS GC는 다른 Parallel GC 보다 작업 속도 빠름

일반적인 CMS GC의 Full GC 처리 시간은 빠르지만, Concurrent mode failure가 발생하면 다른 Parallel GC보다 느려짐

**Concurrent mode failure**

Parallel GC와 CMS GC의 가장 큰 차이점은 압축 작업 여부

압축 작업 : 메모리 할당 공간 사이에 사용하지 않는 빈 공간이 없도록 옮겨서 메모리 단편화를 제거하는 작업

Parallel GC 방식에서는 Full GC가 수행될 때마다 압축 작업 진행

⇒ 시간 많이 소요됨

CMS GC 는 기본적으로 압축 작업을 수행하지 않기 때문에 속도가 빠름

⇒ 압축 작업을 수행하지 않으면 메모리에 빈 공간이 여기저기 생김

⇒ 크기가 큰 객체가 들어갈 수 있는 공간이 없을 수도 있음

그럴 때 Concurrent mode failure라는 경고가 발생하면서 압축 작업 수행(CMS GC를 사용할 때는 압축 시간이 Parallel GC 보다 더 오래 소요됨)

### 3-2 단계 : 메모리 크기

여기서 말하는 메모리 크기는 JVM의 시작 크기와 최대 크기를 말함

**메모리 크기와 GC 발생 횟수, GC 수행 시간의 관계**

- 메모리 크기가 큰 경우
    - GC 발생 횟수는 감소
    - GC 수행 시간 증가
- 메모리 크기가 작은 경우
    - GC 발생 횟수 증가
    - GC 수행 시간 감소

메모리 크기를 지정할 때 해야 하는 것이 한 가지 더 있는데 바로 NewRatio

NewRatio : New 영역과 Old 영역의 비율

NewRatio 값은 GC의 전반적인 성능에 많은 영향을 줌

New 영역의 크기가 작으면 Old 영역으로 넘어가는 메모리의 양이 많아져서 Full GC도 잦아지고 시간도 오래 걸림

GC 튜닝을 가장 빨리 진행하는 방법?

성능 테스트로 결과를 비교하는 것

하지만 운영 상황과 동일하게 부하를 줄 수 있는 환경 구성이 어려움

⇒ 시간이 걸리더라도 운영에 적용하고 결과를 기다리는 것이 더 간단

### 4단계 : GC튜닝 결과 분석

하루 혹은 이틀정도의 로그 데이터 축적 후 결과 확인

**분석할 때 살펴볼 사항**

- Full GC 수행 시간
- Minor GC 수행 시간
- Full GC 수행 간격
- Minor GC 수행 간격
- 전체 Full GC 수행 시간
- 전체 Minor GC 수행 시간
- 전체 GC 수행 시간
- Full GC 수행 횟수
- Minor GC 수행 횟수

GC 옵션을 결정하는 데 가장 큰 비중을 차지하는 것은 Full GC 수행 시간